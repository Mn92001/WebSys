<?php
    session_start();
    ini_set('display_errors', 1);
    error_reporting(E_ALL);
    include '../../inc/db.php'; 

    $errorMsg = $successMsg = "";

    // Retrieve hidden input from approve form
    $userID = $_SESSION['user_id'];
    $pentesterID = $_POST['PentesterID'];
    $approvalStatus = "Suspended"; 
    $dateOfApproval = date("Y-m-d H:i:s"); 
    $adminID = getAdminID($conn, $userID);
    
    // Query statement to update the ApprovalOfPentester table
    $query = "UPDATE ApprovalOfPentester SET AdminID = ?, DateOfApproval = ?, ApprovalStatus = ? WHERE PentesterID = ?";

    // Statement for query
    if ($stmt = $conn->prepare($query)) {
        $stmt->bind_param("issi", $adminID, $dateOfApproval, $approvalStatus, $pentesterID);

        if ($stmt->execute()) {
            // Check if any rows were updated
            if ($stmt->affected_rows > 0) {
                $successMsg .= "The pentester has been successfully suspended.";
                $_SESSION['success'] = $successMsg;
                $_SESSION['suspended'] = "Suspended";

                header("Location: ../../pages/list_of_pentesters.php");
                exit;

            } else {
                $errorMsg .= "No changes were made. Check if the Pentester ID is correct.";
                $_SESSION['error'] = $errorMsg;

                header("Location: ../../pages/list_of_pentesters.php");
                exit;
            }
        } else {
            $errorMsg .= "ERROR: Could not execute query: $query. " . $conn->error;
            $_SESSION['error'] = $errorMsg;

            header("Location: ../../pages/list_of_pentesters.php");
            exit;
        }

        $stmt->close();

    } else {
        $errorMsg .= "ERROR: Could not prepare query: $query. " . $conn->error;
        $_SESSION['error'] = $errorMsg;

        header("Location: ../../pages/list_of_pentesters.php");
        exit;
    }

    // Close connection
    $conn->close();

    // function to get admin ID
    function getAdminID($conn, $userID){
        $queryAdmin = "SELECT AdminID FROM Admin WHERE UserID = ?";
        $adminID = 0;

        // Statement for queryAdmin to get the AdminID
        if ($stmt = $conn->prepare($queryAdmin)) {
            $stmt->bind_param("i", $userID);
            $stmt->execute();
    
            $result = $stmt->get_result();
            if ($result->num_rows > 0) {
                $row = $result->fetch_assoc();
                $adminID = $row['AdminID']; 
            } 
    
            $stmt->close();
        } 
    
        return $adminID;
    }
?>