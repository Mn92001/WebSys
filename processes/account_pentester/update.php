<?php
// update.php

session_start();

include '../../inc/db.php'; 

$userID = $_SESSION['user_id'];

function sanitize_input($data) 
{ 
    $data = trim($data); 
    $data = stripslashes($data); 
    $data = htmlspecialchars($data); 
    return $data; 
} 

function processPdfUpload($file) {
    $maxFileSize = 2 * 1024 * 1024;

    if ($file['type'] != 'application/pdf') {
        return false;
    }

    // Check file size
    if ($file['size'] > $maxFileSize) {
        // File is too large
        return false;
    }

    $pdfContent = file_get_contents($file['tmp_name']);
    if ($pdfContent === false) {
        return false; 
    }

    return ['content' => $pdfContent, 'name' => $file['name']];
}

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $update_type = $_POST["update_type"];
    $errorMsg = "";
    $success = true;

    // Handle different update types
    switch ($update_type) {
        case "email":
            // Handle email update

            if (empty($_POST["email"])) { 
                $errorMsg .= "Email is required."; 
                $success = false; 
            } else { 
                $email = sanitize_input($_POST["email"]); 
                if (!filter_var($email, FILTER_VALIDATE_EMAIL)) { 
                    $errorMsg .= "Invalid email format."; 
                    $success = false; 
                } 
            } 
            // Update email for the user
            $stmt = $conn->prepare("UPDATE UserMaster SET Email = ? WHERE UserID = ?");
            $stmt->bind_param("si", $email, $userID);
            $stmt->execute();
            if ($stmt->affected_rows === 0) {
                $errorMsg = "Failed to update email.";
                $success = false;
            }
            $stmt->close();


            if ($success) {  
                $_SESSION['success'] = "Email has been updated.";
                header("Location: ../../pages/accountpentester.php");
                exit;  
            } else {  
                $_SESSION['error'] = $errorMsg;
                header("Location: ../../pages/accountpentester.php"); 
                exit;
            }
            break;

        case "number":
            // Handle phone number update
            if (!empty($_POST["phoneNumber"])) { 
                $phoneNumber = sanitize_input($_POST["phoneNumber"]); 
        
                if (!preg_match('/^\+?[0-9]+$/', $phoneNumber)) {
                    $errorMsg .= "Invalid phone number format."; 
                    $success = false; 
                } else {
                    // Update phone number for the user
                    $stmt = $conn->prepare("UPDATE UserMaster SET PhoneNumber = ? WHERE UserID = ?");
                    $stmt->bind_param("si", $phoneNumber, $userID);
                    $stmt->execute();
                    if ($stmt->affected_rows === 0) {
                        $errorMsg = "Failed to update phone number.";
                        $success = false;
                    }
                    $stmt->close();
                }
            } 

            if ($success) {  
                $_SESSION['success'] = "Phone number has been updated.";
                header("Location: ../../pages/accountpentester.php");
                exit;  
            } else {  
                $_SESSION['error'] = $errorMsg;
                header("Location: ../../pages/accountpentester.php"); 
                exit;
            }
            break;

        case "password":
            // Handle password update
            $pwd = isset($_POST["pwd"]) ? $_POST["pwd"] : "";
            $pwd_confirm = isset($_POST["pwd_confirm"]) ? $_POST["pwd_confirm"] : "";

            if (empty($pwd)) { 
                $errorMsg .= "Password is required."; 
                $success = false; 
            } elseif (empty($pwd_confirm)) { 
                $errorMsg .= "Confirm Password is required."; 
                $success = false; 
            } elseif ($pwd !== $pwd_confirm) { 
                $errorMsg .= "Passwords do not match."; 
                $success = false; 
            } else { 
                $strongPasswordRegex = "/(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[\W]).{8,}/";
                if (!preg_match($strongPasswordRegex, $pwd)) {
                    $errorMsg .= "Password must contain at least 8 characters, including at least one number, one uppercase letter, one lowercase letter, and one special character."; 
                    $success = false; 
                } else {
                    // Hash the password
                    $pwd_hashed = password_hash($pwd, PASSWORD_DEFAULT);
                    // Update password for the user
                    $stmt = $conn->prepare("UPDATE UserMaster SET Password = ? WHERE UserID = ?");
                    $stmt->bind_param("si", $pwd_hashed, $userID);
                    $stmt->execute();
                    if ($stmt->affected_rows === 0) {
                        $errorMsg = "Failed to update password.";
                        $success = false;
                    }
                    $stmt->close();
                }
            } 

            if ($success) {  
                $_SESSION['success'] = "Phone number has been updated.";
                header("Location: ../../pages/accountpentester.php");
                exit;  
            } else {  
                $_SESSION['error'] = $errorMsg;
                header("Location: ../../pages/accountpentester.php"); 
                exit;
            }
            break;

        case "delete":
            // Handle account deletion
                $stmt = $conn->prepare("DELETE FROM UserMaster WHERE UserID = ?");
                $stmt->bind_param("i", $userID);
                
                // Execute the DELETE statement
                if (!$stmt->execute()) {
                    // Error occurred during execution
                    $errorMsg = "Error deleting record: " . $stmt->error;
                    $success = false;
                } else {
                    // Check if any rows were affected
                    if ($stmt->affected_rows === 0) {
                        $errorMsg = "No rows deleted. User ID might not exist.";
                        $success = false;
                    } else {
                        // Deletion successful
                        session_destroy();
                        $_SESSION['success'] = "Account has been deleted.";
                        header("Location: ../../index.php");
                        exit;
                    }
                }

                // Close the statement
                $stmt->close();
            break;

        case "resume":

             // Check if the resume PDF file was uploaded successfully
            if (isset($_FILES['resumePdf']) && $_FILES['resumePdf']['error'] == 0) {
                // Process the uploaded resume PDF file
                $result = processPdfUpload($_FILES['resumePdf']);
                if (!$result) {
                    $errorMsg .= "There was an error processing the resume PDF or the file is too large.";
                    $success = false;
                } else {
                    // Extract content and filename from the result
                    $resumeContent = $result['content'];
                    $resumeFileName = $result['name'];

                    // Update the resume for the user
                    $stmt = $conn->prepare("UPDATE Pentester SET resumeData = ?, resumeFileName = ? WHERE UserID = ?");
                    $stmt->bind_param("ssi", $resumeContent, $resumeFileName, $userID);
                    $stmt->execute();
                    if ($stmt->affected_rows === 0) {
                        $errorMsg .= "Failed to update resume PDF.";
                        $success = false;
                    }
                    $stmt->close();
                }
            }
            if ($success) {  
                $_SESSION['success'] = "Resume has been updated.";
                header("Location: ../../pages/accountpentester.php");
                exit;  
            } else {  
                $_SESSION['error'] = $errorMsg;
                header("Location: ../../pages/accountpentester.php"); 
                exit;
            }
  
            break;

        case "cert":
            // Check if the rcert PDF file was uploaded successfully
            if (isset($_FILES['certPdf']) && $_FILES['certPdf']['error'] == 0) {
                // Process the uploaded cert PDF file
                $result = processPdfUpload($_FILES['certPdf']);
                if (!$result) {
                    $errorMsg .= "There was an error processing the cert PDF or the file is too large.";
                    $success = false;
                } else {
                    // Extract content and filename from the result
                    $certContent = $result['content'];
                    $certFileName = $result['name'];

                    // Insert cert PDF into the database
                    $stmt = $conn->prepare("UPDATE Pentester SET certData = ?, certFileName = ? WHERE UserID = ?");
                    $stmt->bind_param("ssi", $certContent, $certFileName, $userID);
                    $stmt->execute();
                    if ($stmt->affected_rows === 0) {
                        $errorMsg .= "Failed to update cert PDF.";
                        $success = false;
                    }
                    $stmt->close();
                }
            } 

            if ($success) {  
                $_SESSION['success'] = "Certifications have been updated.";
                header("Location: ../../pages/accountpentester.php");
                exit;  
            } else {  
                $_SESSION['error'] = $errorMsg;
                header("Location: ../../pages/accountpentester.php"); 
                exit;
            }

            break;


            case "coins":
                // Handle coins withdrawal
                if (!empty($_POST["coins"])) {
                    $coins = sanitize_input($_POST["coins"]);
            
                    // Ensure coins is a positive integer
                    if (!is_numeric($coins) || $coins <= 0 || floor($coins) != $coins) {
                        $errorMsg .= "Invalid coins value. Coins must be a positive integer.";
                        $success = false;
                    } else {
                        // Check if the withdrawal amount is lower than the total coins
                        $stmt = $conn->prepare("SELECT TotalCoins FROM UserMaster WHERE UserID = ?");
                        $stmt->bind_param("i", $userID);
                        $stmt->execute();
                        $stmt->store_result();
                        $stmt->bind_result($totalCoins);
                        $stmt->fetch();
                        $stmt->close();
            
                        if ($coins > $totalCoins) {
                            $errorMsg .= "Withdrawal amount cannot exceed total coins.";
                            $success = false;
                        } else {
                            // Update total coins for the user
                            $stmt = $conn->prepare("UPDATE UserMaster SET TotalCoins = TotalCoins - ? WHERE UserID = ?");
                            $stmt->bind_param("ii", $coins, $userID);
                            $stmt->execute();
                            if ($stmt->affected_rows === 0) {
                                $errorMsg = "Failed to update coins.";
                                $success = false;
                            }
                            $stmt->close();
                        }
                    }
                } 
                if ($success) {  
                    $_SESSION['success'] = "Coins withdrawal complete.";
                    header("Location: ../../pages/accountpentester.php");
                    exit;  
                } else {  
                    $_SESSION['error'] = $errorMsg;
                    header("Location: ../../pages/accountpentester.php"); 
                    exit;
                }
                break;
            
        default:
            // Handle unknown update type
            break;
    }

    // Close the database connection
    $conn->close();


} else {  
    $_SESSION['error'] = "Invalid request method.";
    header("Location: ../../pages/accountpentester.php"); 
    exit;
}
?>
