<!DOCTYPE html>
<html lang="en">

<head>
    <title>Pentester Approval</title>
    <?php include "../inc/admincheck.inc.php";?>
    <?php include "../inc/head.inc.php"; ?>
    <?php include "../inc/navadmin.inc.php";?>
    <?php include "../inc/session.inc.php"; ?>
    <?php include "../processes/approval_of_pentester/query.php";?>
    <link rel="stylesheet" href="../assets/css/list_of_pentesters.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
</head> 

<body>

    <main class="container mt-4">
        <h2>Pentester Approval</h2>
         <form action="../processes/approval_of_pentester/actions.php" method="post" class="d-inline me-2">
            <div class="d-inline-flex justify-content-between align-items-center mb-3"> 
                <button type="submit" name="action" value="ApproveSelected" class="btn btn-success btn-custom" data-bs-toggle="tooltip" data-bs-placement="top" title="For pentesters who are pending for approval">Approve</button>
                <button type="submit" name="action" value="RejectSelected" class="btn btn-danger btn-custom" data-bs-toggle="tooltip" data-bs-placement="top" title="For pentesters who are pending for approval">Reject</button>
                <button type="submit" name="action" value="SuspendSelected" class="btn btn-warning btn-custom" data-bs-toggle="tooltip" data-bs-placement="top" title="Suspend account of current pentester">Suspend</button>
        </div>

            <div class="table-responsive">
                <table class="table table-bordered border-info">
                    <thead>
                        <tr class="table-info">
                            <th></th>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Resume</th>
                            <th>Certification</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php while($row = $result->fetch_assoc()): ?>
                            <tr class="<?php echo $row['ApprovalStatus'] == 'Rejected' || $row['ApprovalStatus'] == 'Suspended' ? 'table-secondary' : ''; ?>">
                            <td class="checkbox-container">
                                <?php if($row['ApprovalStatus'] == 'Approved' || $row['ApprovalStatus'] == 'Pending'): ?>
                                    <input class="form-check-input <?php echo $row['ApprovalStatus']; ?>" type="checkbox" name="pentesterIDs[]"value="<?php echo $row['PentesterID']; ?>">             
                                <?php endif; ?>
                            </td>    
                            <td><?php echo htmlspecialchars($row['Username']); ?></td>
                                <td><?php echo htmlspecialchars($row['FullName']); ?></td>
                                <td><a href="../processes/approval_of_pentester/download.php?type=resume&id=<?php echo $row['PentesterID']; ?>" class="btn btn-link btn-sm">Download Resume</a></td>
                                <td><a href="../processes/approval_of_pentester/download.php?type=cert&id=<?php echo $row['PentesterID']; ?>" class="btn btn-link btn-sm">Download Certification</a></td>                    
                                <td class="<?php echo strtolower($row['ApprovalStatus']); ?>"><?php echo htmlspecialchars($row['ApprovalStatus']); ?></td>

                            </tr>
                        <?php endwhile; ?>
                    </tbody>
                </table>
            </div>
        </form>
    </main>     
    <?php include "../inc/footer.inc.php"; ?> 

    <script>
        const approveButton = document.querySelector('button[name="action"][value="ApproveSelected"]');
        const rejectButton = document.querySelector('button[name="action"][value="RejectSelected"]');
        const suspendButton = document.querySelector('button[name="action"][value="SuspendSelected"]');

        function uncheckOthers(status) {
            let allCheckboxes = document.querySelectorAll('.form-check-input');
            allCheckboxes.forEach((cb) => {
                if (!cb.classList.contains(status)) {
                    cb.checked = false;
                }
            });
        }

        function adjustButtonStates() {
            const isAnyPendingChecked = Array.from(document.querySelectorAll('.form-check-input.Pending')).some(cb => cb.checked);
            const isAnyApprovedChecked = Array.from(document.querySelectorAll('.form-check-input.Approved')).some(cb => cb.checked);
            
            if (isAnyPendingChecked) {
                // Pending checkboxes are checked
                suspendButton.disabled = true;
                approveButton.disabled = false;
                rejectButton.disabled = false;
            } else if (isAnyApprovedChecked) {
                // Approved checkboxes are checked
                suspendButton.disabled = false;
                approveButton.disabled = true;
                rejectButton.disabled = true;
            } else {
                suspendButton.disabled = false; 
                approveButton.disabled = false; 
                rejectButton.disabled = false; 
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            let statusCheckboxes = document.querySelectorAll('.form-check-input');
            
            statusCheckboxes.forEach((checkbox) => {
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        let statusClass = Array.from(e.target.classList).find(cl => cl === 'Approved' || cl === 'Pending');
                        uncheckOthers(statusClass);
                    }
                    adjustButtonStates();
                });
            });
        });
</script>


<!-- Activate Bootstrap tooltip -->
<script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
</script>

<script>
        $(document).ready(function() {
            $("table.sortable").tablesorter();
        });
    </script>
    
</body> 

</html> 